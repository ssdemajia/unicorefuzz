#include <sys/socket.h>
#include <linux/if_packet.h>
#include <net/ethernet.h>
#include <unistd.h>
#include <sys/mman.h>
/* 
http://man7.org/linux/man-pages/man7/packet.7.html 
http://www.microhowto.info/howto/capture_ethernet_frames_using_an_af_packet_ring_buffer_in_c.html
sudo setcap cap_net_raw=ep ./a.out 需要给予权限
*/
int main() {
    int fd = socket(AF_PACKET, SOCK_DGRAM, htons(ETH_P_ALL));
    if (fd == -1) {
        perror("socket");
        exit(-1);
    }
    int version = TPACKET_V1;
    if (setsockopt(fd, SOL_SOCKET, PACKET_VERSION, &version, sizeof(version)) == -1) {
        perror("setsocketopt PACKET_VERSION");
        exit(-1);
    } 
    int snaplen = 1500;
    struct tpacket_req req = {0};
    req.tp_frame_size = TPACKET_ALIGN(TPACKET_HDRLEN + ETH_HLEN) + TPACKET_ALIGN(snaplen);
    req.tp_block_size = sysconf(_SC_PAGESIZE);
    while (req.tp_block_size < req.tp_frame_size) req.tp_block_size <<= 1;
    req.tp_block_nr = 10;
    size_t frames_per_buffer = req.tp_block_size / req.tp_frame_size;
    req.tp_frame_nr = frames_per_buffer * req.tp_block_size;
    
    if (setsockopt(fd, SOL_PACKET, PACKET_RX_RING, &req, sizeof(req)) == -1) {
        perror("setsockopt PACKET_RX_RING");
        exit(-1);
    }
    size_t rx_ring_size = req.tp_block_size * req.tp_block_nr;
    char* rx_ring = mmap(0, rx_ring_size. PROT_READ|PROT_WRITE, MAP_SHARED, fd, 0);

}